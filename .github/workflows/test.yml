name: 🧪 Test Suite

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**/target'
      - '**/*.rs.bk'
      - '**/Cargo.lock'
      - 'fai/**'  # Ignore .fai directory to avoid false positives
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: 📦 Test Repository Operations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Test Environment
        run: |
          echo "Setting up test environment..."
          cargo test

      - name: 🧪 Test Basic Repository Workflow
        run: |
          echo "Testing basic repository operations..."
          cargo test test_basic_repository_workflow

      - name: 🌐 Test P2P Networking (Basic)
        run: |
          echo "Testing P2P basic functionality..."
          cargo test test_networking_basic --no-run || echo "P2P tests skipped - not fully implemented"

      - name: 🛡 Test Data Integrity
        run: |
          echo "Testing data integrity and consistency..."
          cargo test test_data_integrity

      - name: 📊 Test Multiple Operations
        run: |
          echo "Testing multiple file operations..."
          cargo test test_multiple_file_operations

      - name: 🔧 Test Error Handling
        run: |
          echo "Testing error handling..."
          cargo test test_error_handling

      - name: 🌳 Test Branch Operations
        run: |
          echo "Testing branch operations..."
          cargo test test_branch_operations

      - name: 📊 Generate Test Report
        run: |
          echo "Generating comprehensive test report..."
          cargo test --test integration_tests 2>&1 | tee test_report.md

  publish:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 📦 Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: 📋 Build and Test
        run: |
          cargo build --release
          cargo test --all
      - name: 🚀 Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo publish --dry-run
          # Uncomment the following line when ready to publish
          # cargo publish

env:
  RUST_BACKTRACE: 1
  RUST_LOG: debug